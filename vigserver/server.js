/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const VIGConsts=require("./core/const"),VIGSettings=require("./settings/settings"),VIGi18n=require("./core/i18n"),initLogger=require("./core/logger"),VIGStorageManager=require("./core/storage").StorageManager,VIGEventbusClass=require("./core/eventbus/eventbus"),Notifys=require("./core/eventbus/notifys"),VIGAppManager=require("./core/app/manager"),VIGServiceManager=require("./core/service/manager"),VIGWebFramework=require("./services/web/webframework"),VIGDeviceManager=require("./core/device/manager"),{getPlatform:getPlatform}=require("./core/platform/platform"),VIGatewayHost=require("./devices/vigateway/vigateway"),async=require("async");class VIServer{start(){async.series({init:async()=>(await initLogger(),logger.info(_("Voerka IoT Wireless platform ready to start.")),logger.debug(_("VIGateway being initialized...")),this.settings=VIGSettings,!0),platform:async()=>(this.platform=getPlatform(),await this.platform.ready(),global.VIGPlatform=this.platform,logger.debug(_("Platform[{}] being initialized.").params(this.platform.sn)),!0),loadStorage:async()=>(this.storage=new VIGStorageManager,global.VIGStorage=this.storage,await this.storage.init(this.platform.sn),logger.debug(_("Storage being initialized.")),!0),getHost:async()=>(this.host=await VIGatewayHost.getHostProxy(),global.VIGateway=this.host,this.debug=this.host.debug,!0),loadDeviceTypes:async()=>(this.deviceManager=new VIGDeviceManager(this),global.VIGDevices=this.deviceManager,await this.deviceManager.load(),logger.debug(_("Devicettypes being loaded :{dts}").params(this.deviceManager.getModuleList())),!0),createEventbus:async()=>(this.eventbus=new VIGEventbusClass(VIGateway.eventbus),global.VIGEventbus=this.eventbus,logger.debug(_("Eventbus is created.")),!0),loadServices:async()=>(this.serviceManager=new VIGServiceManager(this),global.VIGServices=this.serviceManager,await this.serviceManager.load(),logger.debug(_("ServiceManager is successfully loaded : {list}").params(this.serviceManager.getModuleList())),!0),loadApps:async()=>(this.appManager=new VIGAppManager(this),global.VIGApps=this.appManager,await this.appManager.load(),logger.debug(_("AppManager is successfully loaded : {list} ").params(this.appManager.getModuleList())),!0),startServices:async()=>(await this.serviceManager.start(),await this.appManager.start(),await this.deviceManager.start(),!0),Ready:this.onReady.bind(this)},(e,a)=>{for(let e in a)logger.debug("Step : "+e.ljust(36,".")+(a[e]?"OK":"ERROR"));e&&logger.error(_("Error when starting :{err}").params(e.stack))})}async onReady(){try{logger.debug("Update version information...");let{syncVersionInfo:e}=require("utils/version");await e()}catch(e){logger.warn(_("Error while updating version information:{err}").params(e.message))}return!0}async reset(e){if(0===e){let{resetPassword:e}=require("services/web/security/auth");await e("admin","admin")}else e>0&&(VIGStorage.clear(),this.end())}end(){let{NotifyMessage:e}=require("core/eventbus/message");VIGEventbus.notify(e(Notifys.HostRestart)),logger.debug(_("Ready to shutdown after 8 seconds..."));try{VIGServices.onShutdown(),VIGDevices.onShutdown(),VIGApps.onShutdown()}catch(e){}setTimeout(()=>{process.exit(0)},2e4)}error(e){e&&logger.error(getError(e.stack));try{this.serviceManager.getServices("monitor").notice(4)}catch(e){logger.debug(e.message)}}}module.exports=global.VIServer=new VIServer;