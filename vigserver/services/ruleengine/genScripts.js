/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const allowFuncs=require("./funcs").getFuncs();function isValidStatement(e){for(let t in allowFuncs)if(e.startsWith(t+"("))return t;return!1}function normalizeStatement(e){let t=(e=e.trim()).split(";"),n=[];for(let e of t)if(e.trim().length>0){let t=isValidStatement(e);!1===t?logger.warn(_("Invalid rule :{s}").params(e)):n.push(t+".call(context,"+e.substr(t.length+1))}return n.join("\n")}function generateIfStatementScript(e){if("if"===e.operate||void 0===e.operate){e.true&&(e.true=normalizeStatement(e.true)),e.false&&(e.true=normalizeStatement(e.false));let t=`if(${e.condition}){${e.true}\n            }`;return e.false&&(t+=`else{\n                ${e.false}\n            }`),t}return""}function generateScopeRuleScript(e){let t=[];for(let n of e)!1!==n.enabled&&(n.timeslot&&t.push(`if(inTimeSlot('${n.timeslot}')){`),t.push(generateIfStatementScript(n)),n.timeslot&&t.push("}"));return t.join("\n")}function generateOnStatementScript(e,t){let n=[],r=R.flatten(R.map(e=>e.split(","),R.uniq(R.pluck("scope",t)))),i=R.mergeAll(R.map(e=>({[e]:R.filter(t=>t.scope.split(",").includes(e),t)}),r)),l=i[""];i=R.dissoc("",i);let s=0;for(let e in i)s>0?n.push(`}else if(inScope(Device,Message,'${e}')){`):n.push(`if(inScope(Device,Message,'${e}')){`),n.push(generateScopeRuleScript(i[e])),s++;return s>0?R.isEmpty(l)||!l?n.push("}"):(n.push("}else{"),n.push(generateScopeRuleScript(l)),n.push("}")):n.push(generateScopeRuleScript(l)),n.join("\n")}function generateAllRuleScript(e){let t=[];t.push("switch(getMessageTypeName(Message.type)){");for(let n in e)e[n].length>0&&t.push(`case '${n}' :\n                ${generateOnStatementScript(n,e[n])}\n                break;`);return t.push("}"),t.join("\n")}module.exports=generateAllRuleScript;