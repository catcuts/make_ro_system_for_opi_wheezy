/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const{fileExists:fileExists,readFileAsText:readFileAsText}=require("utils/fsplus"),httpErrors=require("httperrors"),artTemplate=require("art-template"),express=require("express");let templateCache={};class WebViewBase{constructor(){this.name="",this.title="",this.description="",this.options={contentType:"text/html",requireAuth:!0},this.router=express.Router(),this.settings()}settings(){this.router.get("/",this.resourceMethod(this.get)).post("/",this.resourceMethod(this.post))}async getTemplate(e,t={}){let s;if((e=e.toLowerCase()).endsWith(".html")||(e+=".html"),t.resquest.currentApp&&(s=path.join(t.resquest.currentApp.root,"web","templates",e)),!await fileExists(s)&&(s=path.join(VIGConsts.VIGRootFolder,"services","web","templates",e),!await fileExists(s)))throw new httpErrors.NotFound(_("Template <{name}> does not found").params(e));return await readFileAsText(s)}async renderTemplate(e,t={}){try{let s=this.getTemplate(e,t);return artTemplate.render(s,t)}catch(t){throw new httpErrors.InternalServerError(_("Render template <{name}> error:{error}").params(e,t.message))}}resourceMethod(e){return async(t,s,r)=>{try{let i;if("string"==typeof(i=util.types.isAsyncFunction(e)||util.types.isPromise(e)?await e.call(this,t,s,r):e.call(this,t,s,r)))s.send(i);else if("object"==typeof i)if("template"in i&&"context"in i&&2===R.keys(i).lenght){let e=i.context;"object"!=typeof e&&(e={},logger.warn(_("Invalid template context:{context}").params(String(e)))),e.request=t,e.response=s,util.types.isAsyncFunction(i)||util.types.isPromise(i)?s.send(await this.renderTemplate(i.template,i.context)):s.send(this.renderTemplate(i.template,i.context))}else s.json(i);else"function"==typeof i&&(util.types.isAsyncFunction(i)||util.types.isPromise(i)?s.send(await i.call(this)):s.send(i.call(this)));s.end()}catch(e){s.json(ErrorApiResponse(err.message)).end()}}}async get(e,t,s){}async post(e,t,s){}async delete(e,t,s){}async put(e,t,s){}async patch(e,t,s){}async head(e,t,s){}toString(){return"WebView[name]".params(this.name)}}module.exports={WebViewBase:WebViewBase};