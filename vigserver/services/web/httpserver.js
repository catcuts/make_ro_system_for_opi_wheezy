/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const http=require("http"),Notifys=require("core/eventbus/notifys");class HTTPServer{constructor(e,t={}){this.express=e,this.settings=Object.assign({port:8e3},{port:t.port})}onError(e){let t="";if("listen"!==e.syscall)throw e;let s="string"==typeof this.port?"Pipe "+this.port:"Port "+this.port;switch(e.code){case"EACCES":t=_("Permission denied,{bind} requires elevated privileges").params(s);break;case"EADDRINUSE":t=_("{bind} is already in use").params(s);break;default:throw t=e,e}logger.debug(t),VIGEventbus.publish(Notifys.HTTPError,{message:t})}onListening(){let e=this.address(),t="string"==typeof e?"pipe "+e:"port "+e.port;logger.info(_("HTTPServer listening on {port}.").params(t)),VIGEventbus.publish(Notifys.HTTPReady,{port:e.port})}async start(){try{this.httpserver=http.createServer(this.express),this.httpserver.listen(this.settings.port),this.httpserver.on("error",this.onError.bind(this)),this.httpserver.on("listening",this.onListening)}catch(e){logger.error(_("Error while create httpserver:{message}").params(e.stack))}}async stop(){return await new Promise((e,t)=>{this.httpserver.close(()=>{VIGEventbus.publish(VIGEventbus.publish(Notifys.HTTPClosed).HTTPClosed),e()})})}}module.exports=HTTPServer;