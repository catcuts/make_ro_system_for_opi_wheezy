/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const{ApiResourceBase:ApiResourceBase}=require("./api/apiresource"),{WebViewBase:WebViewBase}=require("./webview"),express=require("express"),fs=require("fs-extra");function WebSiteMiddleware(e,t,r,s){return(t,r,s)=>{logger.debug("Visit site -> "+e.name+",path= "+t.path),t.currentSite=e,s()}}class WebSite{constructor(e,t){this.router=express.Router(),this.vigmodule=e,this.settings=Object.assign({name:"",title:"",enabled:!0,domain:"",apis:[],views:[],middlewares:[],statics:[],entry:"",webroot:"",url:"",apiUrl:"api",staticUrl:"static",auth:{enabled:!0,handler:""}},t),this._registerMiddleware(),this._registerAPI(),this._registerWebview(),this._registerStatic()}get name(){return this.settings.name||this.vigmodule.name}get apis(){return this.settings.apis}get views(){return this.settings.views}get middlewares(){return this.settings.middlewares}get statics(){return this.settings.statics}get webroot(){return this.settings.webroot}get entry(){return this.settings.entry}_registerMiddleware(){if(Array.isArray(this.middlewares)||(this.middlewares=[middlewares]),this.router.use(WebSiteMiddleware(this)),this.settings.auth.enabled){}try{this.router.use(...this.middlewares)}catch(e){logger.warn(_("Error while register website middleware <{name}>:{err}").params(this.name,e.stack))}}_registerAPI(){try{Array.isArray(apis)||(this.apis=[apis]),R.isEmpty(this.apis)||this.apis.forEach(e=>{e instanceof ApiResourceBase?this.router.use(this.settings.apiUrl,e.router):"object"==typeof e?"url"in e&&"view"in e&&this.router.use(this.settings.apiUrl+e.url,e instanceof ApiResourceBase?e.view.router:e.view):this.router.use(this.settings.apiUrl,e)})}catch(e){logger.error(_("Error while register <{name}> api:{err}").params(this.name,e.stack))}}_registerWebview(){try{Array.isArray(views)||(this.views=[views]),R.isEmpty(this.views)||this.views.forEach(e=>{e instanceof WebViewBase?this.router.use(this.settings.url,e.router):"object"==typeof e?"url"in e&&"view"in e&&this.router.use(this.settings.url+e.url,e instanceof WebViewBase?e.view.router:e.view):this.router.use(this.settings.url,e)})}catch(e){logger.error(_("Error while register <{name}> webview:{err}").params(this.name,e.stack))}}_registerStatic(){try{Array.isArray(this.statics)||(this.statics=[this.statics]);let e=[].concat(this.statics);e.unshift(this.webRoot),e.forEach(e=>{let t={};if("string"==typeof e)t={url:"",path:e};else{if("object"!=typeof e)return void logger.warn(_("invalid <{folder}> parameters").params(e));if(!("path"in e))return void logger.warn(_("Static folder must be {url:<>,folder:<>} parameters"));t=e}if(!fs.existsSync(t.path)){let e=path.join(this.entry,t.path);if(!fs.existsSync(e))try{fs.mkdirsSync(e)}catch(e){return void logger.warn(_("Cannot make folder <>:{err}").params(f,e.message))}t.path=e}t.url=t.url.trim(),""===t.url||t.url.startsWith("/")||(t.url="/"+t.url),router.use(this.settings.staticUrl+t.url,express.static(t.path))})}catch(e){logger.error(_("Error while register static folders in module <{name}>:{err}").params(this.name,e.message))}}}module.exports=WebSite;