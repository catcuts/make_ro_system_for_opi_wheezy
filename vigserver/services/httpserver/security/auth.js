/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
let passport=require("passport"),LocalStrategy=require("passport-local").Strategy,crypto=require("crypto"),PassPortJWT=require("passport-jwt"),jsonwebtoekn=require("jsonwebtoken");function createPassword(e){let t=crypto.createHmac("sha1",VIGateway.secret);return t.update(e),t.digest().toString("base64")}function verifyPassword(e,t){let s=crypto.createHmac("sha1",VIGSettings.secret);return s.update(t),s.digest().toString("base64")===e}function generateApiToken(e){let t={issuer:VIGConsts.ISSUER,audience:VIGConsts.AUDIENCE},s=VIGateway.Attrs.api.expiresIn||"1h";return s&&(t.expiresIn=s),jsonwebtoekn.sign({username:e},VIGateway.Attrs.secret,t)}async function resetPassword(e,t){let s=await VIGStorage.openDocument("users");await s.update({name:e},{password:createPassword(t)})}function verifyAuthenticatedMiddleware(e,t,s){if(e.isAuthenticated())return s();t.redirect("/login")}passport.use("basic",new LocalStrategy(function(e,t,s){VIGStorage.openDocument("users").then(async r=>{r.document.findOne({name:e},function(e,r){return e?s(e):r?verifyPassword(r.password,t)?r.enabled?s(null,r):s(null,!1,{message:_("The account is disabled.")}):s(null,!1,{message:_("Incorrect password.")}):s(null,!1,{message:_("Incorrect username.")})})})})),passport.serializeUser(function(e,t){t(null,e)}),passport.deserializeUser(function(e,t){t(null,e)}),passport.use("api",new PassPortJWT.Strategy({jwtFromRequest:PassPortJWT.ExtractJwt.fromAuthHeaderAsBearerToken(),secretOrKey:VIGateway.attrs.secret,issuer:VIGConsts.ISSUER,audience:VIGConsts.AUDIENCE,session:!1},function(e,t){return t(null,e.username)}));let CommonAuthMiddleware=passport.authenticate("basic",{successRedirect:"/",successFlash:"Welcome!",failureRedirect:"/login",failureFlash:"Invalid username or password."}),ApiAuthMiddleware=passport.authenticate("api");module.exports={verifyAuthenticatedMiddleware:verifyAuthenticatedMiddleware,CommonAuthMiddleware:CommonAuthMiddleware,ApiAuthMiddleware:ApiAuthMiddleware,createPassword:createPassword,verifyPassword:verifyPassword,generateApiToken:generateApiToken,resetPassword:resetPassword};