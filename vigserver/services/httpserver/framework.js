/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const path=require("path"),log4js=require("log4js"),express=require("express"),favicon=require("serve-favicon"),passport=require("passport"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),cookieSession=require("cookie-session"),flash=require("express-flash");let globalRouters=[{name:"index",url:"/",handler:"./views/index"},{name:"auth",url:"/",handler:"./views/auth"}],GlobalServerMiddleware=function(e){return(r,s,a)=>{logger.debug("Visit: "+r.path),r.server=e,r.storage=e.storage,r.eventbus=e.eventbus,a()}};class WebFramework{constructor(e){this.server=e,this.settings={},this.express=express(),this.router=express.Router(),this.express.use(this.router)}async start(e){this.settings=Object.assign({port:80,debug:!1},e);try{this.express.engine("art",require("express-art-template")),this.express.set("views",path.join(__dirname,"templates")),this.express.set("view options",{debug:this.settings.debug,extname:".html"}),this._installMiddlewares(),this._registerGlobalRouters()}catch(e){logger.error(_("Error while initializing express:{message}").params(e.stack))}}_installMiddlewares(){let e=this.settings.secret||VIGConsts.DEFAULT_SECRET,r=path.join(VIGConsts.VIGRootFolder,"www"),s=this.settings.cookieName||"MEEYI_VIGSERVER",a=[{name:"vigserver",param:GlobalServerMiddleware(this)},{name:"favicon",param:favicon(path.join(r,"images","favicon.ico"))},{name:"bodyParserUrl.encoded",param:bodyParser.urlencoded({extended:!1})},{name:"bodyParserJson",param:bodyParser.json({type:"application/*+json"})},{name:"bodyParserText",param:bodyParser.text({type:"text/html"})},{name:"cookieParser",param:cookieParser()},{name:"cookieSession",param:cookieSession({name:s,secret:e})},{name:"static[path=www]",param:express.static(r)},{name:"static[path=data/upload]",param:express.static(path.join(VIGConsts.DataRootFolder,"upload"))},{name:"passport.initialize",param:passport.initialize()},{name:"passport.session",param:passport.session()},{name:"flash",param:flash()},{name:"log4js",param:log4js.connectLogger(log4js.getLogger())}];for(let e of a)try{this.registerMiddleware(e.param)}catch(r){logger.error(_("Error while initializing middleware {name}:{message}").params(e.name,r.stack))}}_registerGlobalRouters(){for(let e of globalRouters)this.registerRouter(e.url,e.handler)}registerRouter(e,r){try{Array.isArray(r)?this.router.use(e,r):"string"==typeof r?this.router.use(e,require(r)):util.isFunction(r)?this.router.use(e,r):logger.warn(_("Error when configuring global router {url}").params(e))}catch(r){logger.error(_("Error while register <{url}> router : {message}").params(e,r.stack))}}registerMiddleware(){try{this.express.use(...arguments)}catch(e){logger.error(_("Error while register express middleware:{message}").params(e.stack))}}}module.exports=WebFramework;