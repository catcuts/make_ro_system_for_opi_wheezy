/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
class SessionTimeoutError extends Error{constructor(s=0){super(),this.message=s>0?"Session <{sid}> is timeout.".params(String(s)):"Session is timeout",this.sid=s}}class Session{constructor(s,e,i){this.id=i,this._resolve=null,this._reject=null,this.waiting=!1,this.manager=s,this.options={nextSession:0},this.lastSendTime=(new Date).getTime(),this.endpoint=e}send(s,e=!0){if(s[this.manager._sessionName]=this.id,this.lastSendTime=(new Date).getTime(),this.manager._send(s),this.waiting=e,e)return new Promise((s,e)=>{this._resolve=s,this._reject=e})}next(s){this._resolve(s),this.waiting=!1}timeout(){this.waiting=!1,this._reject(new SessionTimeoutError(this.id))}end(){this.manager.destroySession(this)}}class SessionManager{constructor(s){s=s||{},this._sessionMaxId=s.sessionMaxId||65535,this._sessionName=s.sessionName||"sid",this._sessionTimeout=s.sessionTimeout||6e4,this._sessionMaxLife=s.sessionMaxLife||6e5,this._send=s.sender,this.endpoints={default:{__sid__:1}},this.trackSessions()}trackSessions(){let s=()=>{for(let s in this.endpoints)for(let e in this.endpoints[s])if("__sid__"!==e){let i=this.endpoints[s][String(e)];i.waiting?(new Date).getTime()-i.lastSendTime>this._sessionTimeout&&i.timeout():(new Date).getTime()-i.lastSendTime>this._sessionMaxLife&&i.end()}setTimeout(s,this._sessionTimeout/2)};setTimeout(s,this._sessionTimeout/2)}sessionInUse(s,e="default"){try{return String(s)in this.endpoints[e]}catch(s){return!1}}getFreeSessionId(s="default"){let e=this.endpoints[s],i=e.__sid__,t=0;for(;String(i)in e;)if(++i>this._sessionMaxId&&(i=1),++t>this._sessionMaxId)return e.__sid__=1,0;return e.__sid__=i,i}createSession(s="default"){s in this.endpoints||(this.endpoints[s]={__sid__:1});let e=this.getFreeSessionId(s);if(0===e)throw new Error(_("Unable to get a valid SessionID,can't create session."));let i=new Session(this,s,e);return this.endpoints[s][String(e)]=i,i}clearEndpoint(s){s in this.endpoints&&(this.endpoints[s]={__sid__:1})}destroySession(s){let e=String(s.id),i=this.endpoints[s.endpoint];try{e in i&&process.nextTick(()=>{delete this.endpoints[s.endpoint][e]})}catch(s){}}getSession(s,e){if(e||(e="default"),s=String(s),"object"==typeof this.endpoints[e])return s in this.endpoints[e]?this.endpoints[e][s]:void 0}isSession(s){try{return s[this._sessionName]>0}catch(s){return!1}}clearSessions(){this.endpoints={default:{__sid__:1}}}}module.exports={SessionManager:SessionManager,Session:Session,SessionTimeoutError:SessionTimeoutError};