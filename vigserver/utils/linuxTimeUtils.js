/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const shell=require("shelljs"),SHELL_CMD_GET_TIME_ZONE="sudo ls -l /etc/localtime | awk '{print $11}' | sed 's/\\/usr\\/share\\/zoneinfo\\///'",SHELL_CMD_SET_TIME_ZONE="sudo ln -sf /usr/share/zoneinfo/{TZ} /etc/localtime",SHELL_CMD_GET_NTP_SERVERS="sudo awk '$1==\"server\"' /etc/ntp.conf",SHELL_CMD_CLR_NTP_SERVERS="sudo sed -i 's/^server.*iburst$/# SERVERS CLEANED/g' /etc/ntp.conf",SHELL_CMD_CLR_PALCEHOLDER="sudo sed -i 's/\\s*#\\s*SERVERS\\s*CLEANED\\s*//g' /etc/ntp.conf",SHELL_CMD_SET_NTP_SERVERS="sudo sed -i '0,/\\s*#\\s*SERVERS\\s*CLEANED\\s*/s//{NTPS}/' /etc/ntp.conf",TIMEOUT_GENERAL=5e3,TIMEOUT_GET_TIME_ZONE=5e3,TIMEOUT_SET_TIME_ZONE=5e3,TIMEOUT_GET_NTP_SERVERS=5e3,TIMEOUT_CLR_NTP_SERVERS=5e3,TIMEOUT_SET_NTP_SERVERS=5e3,SHELL_CMD_CHECK_NTP_SERVERS_EARLIEST="[ -f /etc/ntp.conf.bkup.earliest ] && echo 1 || echo 0",SHELL_CMD_BACKUP_NTP_SERVERS_EARLIEST="sudo cp /etc/ntp.conf /etc/ntp.conf.bkup.earliest",SHELL_CMD_RECOVER_NTP_SERVERS_EARLIEST="sudo cp -p /etc/ntp.conf.bkup.earliest /etc/ntp.conf",SHELL_CMD_BACKUP_NTP_SERVERS="sudo cp -p /etc/ntp.conf /etc/ntp.conf.bkup",SHELL_CMD_RECOVER_NTP_SERVERS="sudo cp -p /etc/ntp.conf.bkup /etc/ntp.conf";class LinuxTimeUtils{constructor(){try{let e=shell.exec(SHELL_CMD_CHECK_NTP_SERVERS_EARLIEST,{silent:!0,timeout:TIMEOUT_GENERAL});0===parseInt(e.stdout)&&shell.exec(SHELL_CMD_BACKUP_NTP_SERVERS_EARLIEST,{silent:!0,timeout:TIMEOUT_GENERAL})}catch(e){}}getTimeZone(){let e;try{e=shell.exec(SHELL_CMD_GET_TIME_ZONE,{silent:!0,timeout:TIMEOUT_GENERAL})}catch(e){throw new Error("Getting timezone error: Timeout")}let r=e.stderr;if(r)throw new Error("Getting timezone error: "+r);return e.stdout.replace(/\n$/,"")}setTimeZone(e){let r,t=SHELL_CMD_SET_TIME_ZONE.replace("{TZ}",e);try{r=shell.exec(t,{silent:!0,timeout:TIMEOUT_GENERAL})}catch(e){throw new Error("Setting timezone error: Timeout")}let E=r.stderr;if(E)throw new Error("Setting timezone error: "+E);if(this.getTimeZone()!==e)throw new Error("Setting timezone error: not working");return e}getNTPServers(){let e;try{e=shell.exec(SHELL_CMD_GET_NTP_SERVERS,{silent:!0,timeout:TIMEOUT_GENERAL})}catch(e){throw new Error("Getting ntp server error: Timeout")}let r=e.stderr;if(r)throw new Error("Getting ntp server error: "+r);return e.stdout.replace(/\n$/,"").split("\n").map(function(e){return e.replace(/^server\s+/,"").replace(/\s+iburst$/,"")})}setNTPServers(e){if(!Array.isArray(e))throw new Error("NTP servers should be array");this._backupNTPServers(),this._clearNTPServers();let r,t=e.map(function(e){return"server "+e+" iburst"}).join("\\n"),E=SHELL_CMD_SET_NTP_SERVERS.replace("{NTPS}",t);try{(r=shell.exec(E,{silent:!0,timeout:TIMEOUT_GENERAL})).stderr||(r=shell.exec("/etc/init.d/ntp restart",{silent:!1,timeout:6e4}))}catch(e){throw new Error("Setting ntp error: Timeout")}let n=r.stderr;if(n)throw new Error("Setting ntp error: "+n);{this._clearPlaceholder();let r=this.getNTPServers();if(e.filter(function(e){return-1!==r.indexOf(e)}).length===e.length)return e;throw this._recoverNTPServers(),new Error("Setting ntp error: not working, recovered")}}_backupNTPServers(){let e;try{e=shell.exec(SHELL_CMD_BACKUP_NTP_SERVERS,{silent:!0,timeou:TIMEOUT_GENERAL})}catch(e){throw new Error("Backupping ntp error: Timeout")}let r=e.stderr;if(r)throw new Error("Backupping ntp error: "+r);return!0}_clearNTPServers(){let e;try{e=shell.exec(SHELL_CMD_CLR_NTP_SERVERS,{silent:!0,timeout:TIMEOUT_GENERAL})}catch(e){throw new Error("Cleaning ntp error: Timeout")}let r=e.stderr;if(r)throw new Error("Cleaning ntp error: "+r);return!0}_clearPlaceholder(){let e;try{e=shell.exec(SHELL_CMD_CLR_PALCEHOLDER,{silent:!0,timeout:TIMEOUT_GENERAL})}catch(e){throw new Error("Cleaning placeholder error: Timeout")}let r=e.stderr;if(r)throw new Error("Cleaning placeholder error: "+r);return!0}_recoverNTPServers(){let e,r=!1;try{e=shell.exec(SHELL_CMD_RECOVER_NTP_SERVERS,{silent:!0,timeout:TIMEOUT_GENERAL})}catch(e){r=!0}let t=e.stderr;if(!t&&!r)return!0;try{shell.exec(SHELL_CMD_RECOVER_NTP_SERVERS_EARLIEST,{silent:!0,timeout:TIMEOUT_GENERAL})}catch(e){throw new Error("Recovering ntp error: "+t)}}}module.exports={TimeManager:LinuxTimeUtils};