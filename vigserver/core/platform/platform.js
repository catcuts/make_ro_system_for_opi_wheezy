/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const YAWN=require("yawn-yaml/cjs"),path=require("path"),fs=require("fs"),uuid=require("uuid"),os=require("os"),VIMPErrors=require("core/protocols/vimp/errors"),NullMacAddress="00:00:00:00:00:00";function getMac(){let e=os.networkInterfaces();"eth0"in e&&(e=[e.eth0]);for(let r in e)for(let t of e[r])if(t.mac!==NullMacAddress)return t.mac;return NullMacAddress}function getSerialNo(e=!1){let r=path.join(VIGConsts.VIGRootFolder,"serialno"),t=e,s="";try{t=12!==(s=fs.readFileSync(r,encoding="utf-8")).trim().length}catch(e){t=!0}return t&&(s=uuid.v4().replace(/\-/g,"").substr(0,12),fs.writeFileSync("serialno",s)),s}class Platform{constructor(e){this.schema={},this.name="",this._loadDefaultSchema(),this._mergeSchema()}_mergeSchema(){Object.assign(this.schema,this.loadSchema())}_loadDefaultSchema(){let e=path.join(__dirname,"schemas","default.yaml");try{this.schema=new YAWN(fs.readFileSync(e,{encoding:"utf8"})).json}catch(e){logger.error(_("Error while load platform schema file :{err}").params(e.stack))}}loadSchema(){let e=path.join(__dirname,"schemas",this.constructor.name,".yaml");if(!fs.existsSync(e))return{};try{return new YAWN(fs.readFileSync(e,{encoding:"utf8"})).json}catch(r){return logger.error(_("Error while load platform schema file [file] :{err}").params(e,r.stack)),{}}}async ready(){await this.network.restore();try{if(this.schema.mac=getMac(),this.schema.mac===NullMacAddress)throw new Error("invalid mac address");this.schema.sn=this.schema.mac.toLowerCase().replace(/[\-|\:]/g,"")}catch(e){logger.warn(_("Error while get mac address:{error}").params(e)),this.schema.sn=getSerialNo()}}get mac(){return this.schema.mac}get os(){return Object.assign(this.schema.os||{},{arch:process.arch,platform:process.platform})}get timeZone(){throw new VIMPErrors.UnsupportedError}set timeZone(e){throw new VIMPErrors.UnsupportedError}get sn(){return this.schema.sn||getSerialNo()}get screen(){return this.schema.screen||{}}get cpu(){return this.schema.cpu||{}}get serialports(){return this.schema.serialports||[]}get cameras(){return this.schema.cameras||[]}get network(){throw new VIMPErrors.UnsupportedError}reboot(){}reset(e){if(1===e){require("fs-extra").emptyDirSync(path.join(VIGConsts.DataRootFolder,"storage"))}}error(e){}}function getPlatform(){let e=VIGSettings.platform||"",r=path.join(__dirname,"schemas",e+".js"),t=null;if(e&&fs.existsSync(r))try{t=new(require("./schemas/"+e))}catch(r){logger.warn(_("Hardware platform {name} implementation does not exist.").params(e))}return t||(t=new Platform),t}module.exports={getPlatform:getPlatform,Platform:Platform};