/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const{isJson:isJson,isNumber:isNumber}=require("utils/typecheck"),VIMPErrors=require("core/protocols/vimp/errors"),jsonpath=require("jsonpath"),deepMerge=require("deep-extend");class DeviceAttrBase{constructor(e){this.meta=e}async update(e,t){}async find(e,t){}}class StorageDeviceAttr extends DeviceAttrBase{validate(e){return!0}useWholeStorage(){let e=this.meta.select;return!("select"in this.meta)||"string"==typeof e&&""===e.trim()||isJson(e)&&R.isEmpty(e)}async update(e,t){let r=await VIGStorage.openDocument(this.meta.storage);if(!this.validate(t))throw new VIMPErrors.ParamError(_("Invalid device attr,validate fail"));if(this.useWholeStorage())return""===e&&new VIMPErrors.ParamError(_("lose of <query> parameters")),await r.update(e,{$set:t},{returnUpdatedDocs:!0});{let r=await this.getAttrRecord(),a=(this.meta.where||"").trim();return jsonpath.apply(r,a,r=>(""===e?isJson(r)&&isJson(t)?deepMerge(r,t):r=t:jsonpath.apply(r,e,e=>(isJson(e)&&isJson(t)?deepMerge(e,t):e=t,e)),r)),await this.saveAttrRecord(r)}}async getAttrRecord(){let e=await VIGStorage.openDocument(this.meta.storage),t=this.meta.select;if("string"==typeof t&&(t=JSON.parse(t)),R.isEmpty(t))throw new VIMPErrors.FailError(_("Attr {name} does not specify a valid metadata <select>").params(this.meta.name));return await e.findOne(t)}async saveAttrRecord(e){let t=this.meta.select;"string"==typeof t&&(t=JSON.parse(t));let r=await VIGStorage.openDocument(this.meta.storage);return await r.update(t,{$set:e})}async findAttrByQuery(e){let t=null,r=String(e.where);return t=await this.findAttrByDirect(),""!==r.trim()&&(t={[r]:(t=jsonpath.query(t,r)).length>0?t[0]:null}),t}async findAttrByDirect(){let e=[],t=await this.getAttrRecord(),r=this.meta.where||"";return(e=""===r?t:jsonpath.query(t,r)).length>0?e[0]:null}async findMapArrayAttr(e){let t=e.where||{},r=!0;try{"string"==typeof t?t=JSON.parse(t):isJson(t)||(r=!1)}catch(e){r=!1}if("sort"in e&&(r=r&&isJson(e.sort)),!0===e.paging&&(r=r&&isNumber(e.pageSize||10)&&isNumber(e.pageNum||1)),!r)throw new VIMPErrors.ParamError(_("Invalid query parameter"));let a=Object.assign({where:{},sort:{},paging:!1,pageSize:10,pageNum:1},e),i=null,s=await VIGStorage.openDocument(this.meta.storage);return i=s.document.find(a.where),R.isEmpty(a.sort)||(i=i.sort(a.sort)),!0===a.paging&&(i=i.skip(a.pageSize*(a.pageNum-1)).limit(a.pageSize)),await new Promise((e,t)=>{i.exec((r,a)=>{r?t(r):e(a)})})}async find(e,t={}){return"map-array"===this.meta.valuetype?await this.findMapArrayAttr(e):["map","array"].includes(this.meta.valuetype)?await this.findAttrByQuery(e):await this.findAttrByDirect()}}class NetworkDeviceAttr extends DeviceAttrBase{async update(e,t){return await VIGPlatform.network.configure(t)}async find(e,t={}){let r=await VIGPlatform.network.interfaces(),a=e.where,i={};if(a in r)i=r[e];else{if("string"!=typeof a)throw i=jsonpath.query(r,a),new VIMPErrors.ParamError(_("Invalid network interface"));"default"===(a=a.toLowerCase())||""===a?i={default:await VIGPlatform.network.default()}:"wifi"===a&&(i={wifi:await VIGPlatform.network.defaultWifi()})}return i}}class TimeDeviceAttr extends DeviceAttrBase{async update(e,t){"timeZone"===this.meta.name&&(VIGPlatform.timeZone=t)}async find(e,t={}){return"timeZone"===this.meta.name?VIGPlatform.timeZone:"datetime"===this.meta.name?new Date:void 0}}const DeviceAttrClasss={StorageDeviceAttr:StorageDeviceAttr,NetworkDeviceAttr:NetworkDeviceAttr,OSTimeDeviceAttr:TimeDeviceAttr};function getDeviceAttrClass(e){try{return(e=e.trim()).startsWith("@")?DeviceAttrClasss[e.substr(1)]:e.startsWith("!")?require(e.substr(1)):StorageDeviceAttr}catch(e){return StorageDeviceAttr}}module.exports={DeviceAttrBase:DeviceAttrBase,StorageDeviceAttr:StorageDeviceAttr,NetworkDeviceAttr:NetworkDeviceAttr,getDeviceAttrClass:getDeviceAttrClass,TimeDeviceAttr:TimeDeviceAttr};