/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const VAMP=require("../vamp/message"),{MessageTypes:MessageTypes}=require("../vamp/constants"),TransRules=require("./rules"),{encodeSerialNo:encodeSerialNo,decodeSerialNo:decodeSerialNo,encodeParams:encodeParams}=require("../vamp/message"),{getPayloadRulesParams:getPayloadRulesParams,getAttrsPayloadRulesParams:getAttrsPayloadRulesParams}=require("./utils");function convertAnswerCode(e){let a=String(e);return 10*parseInt(a.charAt(0))+parseInt(a.charAt(2))}function convertToVampFlags(e={}){try{for(let a in e)e[a]=Number(e[a])}catch(e){logger.debug(_("Error while convert to vamp flags:{flags}").params(e.message))}return e}function convertPayloadFields(e,a,s,t={}){let r={},o={},l={},n=!0,i=null;for(let d in e){o=d in s?s[d]:d in a?a[d]:{},(n=d in t)&&(o=Object.assign(t[d],o));let y=void 0===o.to||""===o.to?d:o.to;"string"!=typeof o.valuetype||n||(l[y]=o.valuetype),i="function"==typeof o.value?o.value.call(e,e[d]):"object"==typeof o.value?e[d]in o.value?o.value[e[d]]:e[d]:void 0===o.value?e[d]:o.value,r[y]=i}return r.paramTypes=l,r}function convertArrayAttrs(e,a,s){let t=[];for(let r of e)r in s?fieldRule=s[r]:r in a&&(fieldRule=a[r]),t.push(void 0===fieldRule.to||""===fieldRule.to?r:fieldRule.to);return t}function convertAttrsPayload(e,a={}){let s=VIGDevices.getDeviceTypeName(e.to),t={};void 0!==e.tid&&e.tid>0&&(e.payload.tid=e.tid,a&&Object.assign(a,{tid:"uint32"}));let r=getAttrsPayloadRulesParams(TransRules,s);return delete e.payload._batch_,t=convertPayloadFields(e.payload,...r),a=Object.assign(t.paramTypes,a||{}),delete t.paramTypes,VAMP.AttrsMessage.encodePayload({paramTypes:a,...t})}function convertQueryPayload(e){let a=VIGDevices.getDeviceTypeName(e.to),s={},t=getAttrsPayloadRulesParams(TransRules,a);return t[2]=TransRules.Query.__fixed__,"fields"in(s=convertPayloadFields(e.payload,...t))&&(s.fields=convertArrayAttrs(s.fields,t[0],t[1])),delete s.paramTypes,VAMP.QueryMessage.encodePayload(s)}function convertNormarlPayload(e,a,s,t={},r=""){let o=VIGDevices.getDeviceTypeName(s.to);s.tid&&(s.payload.tid=s.tid,t&&Object.assign(t,{tid:"uint32"}));let l=getPayloadRulesParams(TransRules,e,o,r),n=convertPayloadFields(s.payload,...l);return t=Object.assign(n.paramTypes,t||{}),"tid"in l[2]&&delete t.tid,delete n.paramTypes,a({paramTypes:t,...n})}function VimpToVamp(e){let a={};""!==e.from&&e.from!==VIGateway.sn||(e.from=VIGateway.shortSn);let s=convertToVampFlags(e.flags);switch(e.type){case MessageTypes.Notify:let s=e.payload.code;a=convertNormarlPayload("Notify",VAMP.NotifyMessage.encodePayload,e,e.__paramtypes__,s);break;case MessageTypes.Attrs:a=convertAttrsPayload(e,e.__paramtypes__);break;case MessageTypes.Action:let t=e.payload.action||"";a=convertNormarlPayload("Actions",VAMP.ActionMessage.encodePayload,e,e.__paramtypes__,t);break;case MessageTypes.Alarm:case MessageTypes.Event:case MessageTypes.Message:case MessageTypes.Data:break;case MessageTypes.Query:a=convertQueryPayload(e);break;case MessageTypes.Answer:a=convertNormarlPayload("Answer",VAMP.AnswerMessage.encodePayload,e,e.__paramtypes__)}return VAMP.encodeMessage({type:e.type,from:e.from,to:e.to,sid:e.sid,flags:s,roaming:VIGateway.roamingGroup||0,payload:a})}module.exports=VimpToVamp;