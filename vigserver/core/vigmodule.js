/*ã€€China Fujian Huanyutong Technology Co., Ltd. */
const express=require("express"),EventBusNode=require("core/eventbus/node"),async=require("async"),DocumentRecord=require("core/storage").DocumentRecord,Notifys=require("core/eventbus/notifys"),assert=require("assert"),{ApiResourceBase:ApiResourceBase}=require("services/web/api/apiresource"),{WebViewBase:WebViewBase}=require("services/web/webview"),VIGModuleStatus={Initial:0,Starting:1,Runing:2,Stoping:3,Stoped:4,AttrsLoaded:6,Error:9},ModuleStatusText=["Initial","Staring","Running","Stoping","Stoped","Error"];class VIGModuleManager{constructor(e){this.server=e,this.modules=[],this.moduleType="",this.storageName="",this.urlprefix=""}registerWebsite(e){for(let t of this.modules)try{t.website&&e.use(this.urlprefix,t.website.router)}catch(e){logger.error(_("Error while register module <{name}> website ").params(t.name,e.stack))}}async getModules(){let e=[];try{let t=await VIGStorage.openDocument(this.storageName);e=await t.find({enabled:!0})}catch(e){logger.warn(_("Error while load <{type}> modules:{err}").params(this.moduleType,e.message))}return 0===e.length&&logger.warn(_("Modules<{type}> is empty").params(this.moduleType)),e}async getModuleAttrs(e){let t;try{let s=await VIGStorage.openDocument(this.storageName);t=await s.find({name:e})}catch(t){logger.warn(_("Error while load module <{name}>:{err}").params(e,t.message))}return null===t&&logger.warn(_("Module <{name}> is not exists.").params(e)),t}getModuleClass(e){}async load(){let e=await this.getModules(),t=new Array(...e);t=t.sort(function(e,t){return(e.order||0)-(t.order||0)});for(let e of t)await this.loadModule(e)}async unload(){await new Promise((e,t)=>{async.parallel(this.modules.map(e=>async()=>{await this.unloadModule(e)}),(e,t)=>{this.modules=[]})})}async reloadModule(e){let t,s=e;"string"==typeof e?(t=e,s=this.getModuleByName(moduleName)):t=e.name,s&&await this.unloadModule(s);let a=await this.getModuleAttrs(t);await this.loadModule(a)}async unloadModule(e){logger.debug(_("Unloading module <{name}>").params(this.moduleType,e.name));try{await e._stop(),await e.onUnload()}catch(t){logger.warn(_("Error while unload module <{module}:{name}>").params(this.moduleType,e.name))}R.dropWhile(e=>e.name==e.name,this.modules)}async loadModule(e){if(!1!==e.enabled)try{let t=new(this.getModuleClass(e))(VIServer,e);return this.modules.push(t),await t.init(),await t.onLoad(),t}catch(t){logger.error(_("Error while create {module} <{name}> instance:{error}").params(this.moduleType,e.name,t.stack))}else logger.debug(_("{module} <{name}> is disabled.").params(this.moduleType.firstUpper(),e.name))}async _startModule(e){try{await e._start(),logger.debug(_("{module}<{name}> is has been started.").params(this.moduleType.firstUpper(),e.name))}catch(t){logger.error(_("Error while startup {module} {name}:{message}").params(this.moduleType,e.name,t.stack))}}async start(){0!==this.modules.length?(logger.debug(_("Starting {module}s....").params(this.moduleType)),async.parallel(this.modules.map(e=>async()=>{await this._startModule(e)}),(e,t)=>{})):logger.warn(_("No {module}s was loaded.").params(this.moduleType))}async registerModule(e,t=!1){this.moduleIsExisted(e.name||"")||(e.init(),this.modules.push(e),e.onLoad(),t&&moduleInst&&await e._start())}getModuleByName(e){let t=this.modules.filter(t=>t.name.toLowerCase()===e.toLowerCase())||[];return 0===t.length?null:t[0]}moduleIsExisted(e){return(this.modules.filter(t=>t.name.toLowerCase()===e.toLowerCase())||[]).length>0}getModuleList(){return this.modules.map(e=>e.name).join(",")}onShutdown(){for(let e of this.modules)try{e._stop()}catch(e){logger.warn(_("Error when stoping module <{module}>:{err}").params(this.moduleType,e.message))}}}class VIGModule extends DocumentRecord{constructor(e,t={}){super((t=Object.assign({moduleType:"module",storageName:"",storagePrimaryKey:"name"},t)).storageName,t.storagePrimaryKey),this.status=VIGModuleStatus.Initial,this.statusText=ModuleStatusText[0],this.moduleType=t.moduleType,this.root="",this.urlprefix="",this.setAttrs(e)}async refresh(){await this.load();await this.restart()}getDefaultAttrs(){return{order:0,enabled:!0,web:{requireAuth:!1,authMiddleware:"",enabled:!0},connectEventbus:!0,subscribe:""}}get host(){return VIGateway}get vmc(){return void 0===this._vmc&&(this._vmc=VIGServices.getServices("vmc")),this._vmc}assertReady(){assert.equal(this.status,VIGModuleStatus.Runing,_("{module} <{name}> is not ready.").params(this.moduleType.firstUpper(),this.name))}toString(){return this.name}get canStart(){return[VIGModuleStatus.Stoped,VIGModuleStatus.Initial,VIGModuleStatus.Error].includes(this.status)}get canStop(){return[VIGModuleStatus.Runing,VIGModuleStatus.Error].includes(this.status)}async init(){}connectToEventbus(){this.attrs.connectEventbus&&(this.node||(this.node=new EventBusNode(this.getEventbusNodeName())),this.node.context=this,this.node.onMessage=this.onMessage.bind(this),this.node.onPulse=this.onPulse.bind(this),this.node.onNotify=this.onNotify.bind(this),this.node.onError=this.onError.bind(this),this.node.connect(),this.subscribeMessages())}disconnectFromEventbus(){this.attrs.connectEventbus&&this.node&&this.node.disconnect()}get name(){return this.attrs.name}get title(){return this.attrs.title}get order(){return this.attrs.order}get enabled(){return this.attrs.enabled}getEventbusNodeName(){return(this.moduleType+"."+this.name).toLowerCase()}async onMessage(e){}async onPulse(){}async onNotify(e){}async onError(e){}async onLoad(){}async onUnload(){}subscribeMessages(e){e?"string"==typeof e&&(e=e.split(",")):e=(this.attrs.subscribe||"").split(",");for(let t of e)t&&(this.node.unsubscribe(t),this.node.subscribe(t))}_changeStatus(e,t){this.status=e,this.statusText=t||ModuleStatusText[e],this.broadcastNotify(e,{message:this.statusText})}broadcastNotify(e,t={}){this.node&&this.node.notify(e,t)}async _start(){if(this.canStart)try{this.connectToEventbus(),this._changeStatus(VIGModuleStatus.Starting),await this.start(),this._changeStatus(VIGModuleStatus.Runing),await this.onStart()}catch(e){this._changeStatus(VIGModuleStatus.Error,e),logger.error(_("Error while start {module} {name} : {message}").params(this.moduleType,this.name,e.stack))}else logger.debug(_("{module} {name} cannot be started.Current status={status}").params(this.moduleType.firstUpper(),this.name,ModuleStatusText[this.status]))}async _stop(){if(this.canStop)try{this._changeStatus(VIGModuleStatus.Stoping),await this.stop(),this._changeStatus(VIGModuleStatus.Stoped),await this.onStop(),this.disconnectFromEventbus()}catch(e){this._changeStatus(VIGModuleStatus.Error,e),logger.error(_("Error while start {module} {name} : {message}").params(this.moduleType.firstUpper(),this.name,e.stack))}else logger.warn(_("{module} {name} cannot be stoped.Current status:{status}").params(this.moduleType.firstUpper(),this.name,this.status))}async onStart(){}async onStop(){}async start(){}async stop(){}async restart(){await this._stop(),await this._start()}setAttrs(e){super.setAttrs(Object.assign(this.getDefaultAttrs(),e||{})),void 0!==this.attrs.web.enabled&&this.attrs.web.enabled?this.website||(this.website=this.getWebSite()):this.website=null,this.subscribeMessages(),this.broadcastNotify(Notifys.ModuleAttrsLoaded)}getWebSite(){}error(e,t={}){this.node&&this.node.error(e,t)}}module.exports={VIGModule:VIGModule,VIGModuleManager:VIGModuleManager,VIGModuleStatus:VIGModuleStatus};